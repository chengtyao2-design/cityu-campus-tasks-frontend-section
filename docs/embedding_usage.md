# å‘é‡åµŒå…¥å’Œ FAISS ç´¢å¼•ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

æœ¬é¡¹ç›®å®žçŽ°äº†åŸºäºŽ BGE-small-zh-v1.5 æ¨¡åž‹çš„ä¸­æ–‡æ–‡æœ¬å‘é‡åµŒå…¥å’Œ FAISS ç´¢å¼•ç³»ç»Ÿï¼Œæ”¯æŒè¯­ä¹‰æœç´¢å’Œç›¸ä¼¼åº¦åŒ¹é…ã€‚

## æ ¸å¿ƒç»„ä»¶

### 1. app/services/embedder.py
- **TextChunker**: æ–‡æœ¬åˆ†å—å™¨ï¼Œæ”¯æŒ 400-700 å­—ç¬¦åˆ†å—ï¼Œ80-120 å­—ç¬¦é‡å 
- **EmbeddingService**: åµŒå…¥æœåŠ¡ï¼Œä½¿ç”¨ BGE-small-zh-v1.5 æ¨¡åž‹
- **FAISSIndexManager**: FAISS ç´¢å¼•ç®¡ç†å™¨ï¼Œæ”¯æŒæž„å»ºã€ä¿å­˜ã€åŠ è½½ç´¢å¼•

### 2. scripts/build_index.py
- CLI å·¥å…·ï¼Œç”¨äºŽæž„å»ºå’Œæµ‹è¯• FAISS ç´¢å¼•
- æ”¯æŒä»Ž JSONL/JSON æ•°æ®æž„å»ºç´¢å¼•
- å†…ç½®æµ‹è¯•åŠŸèƒ½ï¼ŒéªŒè¯ç›¸ä¼¼åº¦é˜ˆå€¼

## CLI ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬æž„å»ºç´¢å¼•
```bash
python scripts/build_index.py --data data/task_kb.jsonl --output indices/task_index
```

### æž„å»ºå¹¶æµ‹è¯•ç´¢å¼•
```bash
python scripts/build_index.py --data data/task_kb.jsonl --output indices/task_index --test
```

### ä»…æµ‹è¯•çŽ°æœ‰ç´¢å¼•
```bash
python scripts/build_index.py --test-only --index indices/task_index --top-k 4 --min-similarity 0.35
```

### è‡ªå®šä¹‰å‚æ•°
```bash
python scripts/build_index.py \
  --data data/task_kb.jsonl \
  --output indices/custom_index \
  --model BAAI/bge-small-zh-v1.5 \
  --chunk-size 600 \
  --overlap 120 \
  --test \
  --top-k 5 \
  --min-similarity 0.4
```

### è‡ªå®šä¹‰æµ‹è¯•æŸ¥è¯¢
```bash
python scripts/build_index.py \
  --test-only \
  --index indices/task_index \
  --queries "å›¾ä¹¦é¦†åœ¨å“ªé‡Œ" "å¦‚ä½•ä½¿ç”¨å®žéªŒå®¤" "å­¦ç”Ÿæ´»åŠ¨å®‰æŽ’" \
  --verbose
```

## å‚æ•°è¯´æ˜Ž

| å‚æ•° | è¯´æ˜Ž | é»˜è®¤å€¼ |
|------|------|--------|
| `--data/-d` | çŸ¥è¯†åº“æ•°æ®æ–‡ä»¶è·¯å¾„ | å¿…éœ€ |
| `--output/-o` | è¾“å‡ºç´¢å¼•è·¯å¾„ï¼ˆä¸å«æ‰©å±•åï¼‰ | `data/index` |
| `--model/-m` | åµŒå…¥æ¨¡åž‹åç§° | `BAAI/bge-small-zh-v1.5` |
| `--chunk-size` | æ–‡æœ¬åˆ†å—å¤§å° | `550` |
| `--overlap` | åˆ†å—é‡å å¤§å° | `100` |
| `--test` | æž„å»ºåŽæµ‹è¯•ç´¢å¼• | `False` |
| `--test-only` | ä»…æµ‹è¯•çŽ°æœ‰ç´¢å¼• | `False` |
| `--index/-i` | æµ‹è¯•ç”¨ç´¢å¼•è·¯å¾„ | å¿…éœ€ï¼ˆæµ‹è¯•æ—¶ï¼‰ |
| `--top-k` | è¿”å›žç»“æžœæ•°é‡ | `4` |
| `--min-similarity` | æœ€å°ç›¸ä¼¼åº¦é˜ˆå€¼ | `0.35` |
| `--queries` | è‡ªå®šä¹‰æµ‹è¯•æŸ¥è¯¢ | å†…ç½®æŸ¥è¯¢ |
| `--verbose/-v` | è¯¦ç»†è¾“å‡º | `False` |

## è¾“å‡ºæ–‡ä»¶

æž„å»ºç´¢å¼•åŽä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š
- `{output_path}.faiss`: FAISS ç´¢å¼•æ–‡ä»¶
- `{output_path}.json`: å…ƒæ•°æ®æ–‡ä»¶ï¼ˆåŒ…å«æ–‡æœ¬å—ã€æ¥æºã€å…ƒæ•°æ®ï¼‰

## æµ‹è¯•éªŒè¯

### å†…ç½®æµ‹è¯•æŸ¥è¯¢
1. "å›¾ä¹¦é¦†åœ¨å“ªé‡Œ"
2. "å¦‚ä½•ä½¿ç”¨å®žéªŒå®¤è®¾å¤‡"
3. "å­¦ç”Ÿæ´»åŠ¨ä¸­å¿ƒçš„å¼€æ”¾æ—¶é—´"
4. "è®¡ç®—æœºç§‘å­¦è¯¾ç¨‹"
5. "æ ¡å›­å®‰å…¨è§„å®š"

### éªŒæ”¶æ ‡å‡†
- âœ… å¯é‡å¤æž„å»ºï¼šå¤šæ¬¡è¿è¡Œäº§ç”Ÿç›¸åŒç»“æžœ
- âœ… ç›¸ä¼¼åº¦é˜ˆå€¼ï¼štop_k=4 ç»“æžœç›¸ä¼¼åº¦ â‰¥0.35
- âœ… ç´¢å¼•æŒä¹…åŒ–ï¼šç”Ÿæˆ .faiss å’Œ .json æ–‡ä»¶
- âœ… æ–‡æœ¬åˆ†å—ï¼š400-700 å­—ç¬¦ï¼Œ80-120 é‡å 

## ç¤ºä¾‹è¾“å‡º

```
ðŸ”§ å¼€å§‹æž„å»ºç´¢å¼•
æ•°æ®æ–‡ä»¶: data/task_kb.jsonl
è¾“å‡ºè·¯å¾„: indices/task_index
æ¨¡åž‹: BAAI/bge-small-zh-v1.5
åˆ†å—å¤§å°: 550 é‡å : 100
============================================================
âœ… ç´¢å¼•æž„å»ºå®Œæˆ: indices/task_index.faiss

ðŸ§ª å¼€å§‹æµ‹è¯•ç´¢å¼•...
âœ… æŸ¥è¯¢: å›¾ä¹¦é¦†åœ¨å“ªé‡Œ
   æ‰¾åˆ° 1 ä¸ªç»“æžœ æœ€é«˜ç›¸ä¼¼åº¦: 0.459
   [1] 0.459 - æ ¡å›­å¯¼è§ˆè¦ç‚¹ï¼š1. é¦™æ¸¯åŸŽå¸‚å¤§å­¦æˆç«‹äºŽ1984å¹´...

ðŸ“Š æµ‹è¯•æ€»ç»“
==================================================
æ€»æŸ¥è¯¢æ•°: 5
æˆåŠŸæŸ¥è¯¢æ•°: 5
æˆåŠŸçŽ‡: 100.0%
å¹³å‡ç›¸ä¼¼åº¦: 0.540
ç›¸ä¼¼åº¦é˜ˆå€¼: 0.35
âœ… æµ‹è¯•é€šè¿‡: æ»¡è¶³ç›¸ä¼¼åº¦è¦æ±‚

ðŸŽ‰ æ“ä½œå®Œæˆ!
```

## ç¼–ç¨‹æŽ¥å£

### ä½¿ç”¨ EmbeddingService
```python
from app.services.embedder import EmbeddingService

# åˆå§‹åŒ–æœåŠ¡
service = EmbeddingService()

# æž„å»ºç´¢å¼•
texts = ["æ–‡æœ¬1", "æ–‡æœ¬2", "æ–‡æœ¬3"]
sources = ["source1", "source2", "source3"]
metadata = [{"key": "value"}, {}, {}]

index = service.build_index_from_texts(texts, sources, metadata)

# ä¿å­˜ç´¢å¼•
index_path, metadata_path = service.save_index("my_index")

# åŠ è½½ç´¢å¼•
service.load_index("my_index")

# æœç´¢
results = service.search("æŸ¥è¯¢æ–‡æœ¬", top_k=5)
```

## æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜

1. **æ¨¡åž‹ä¸‹è½½å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿žæŽ¥
   - è®¾ç½® HuggingFace é•œåƒï¼š`export HF_ENDPOINT=https://hf-mirror.com`

2. **å†…å­˜ä¸è¶³**
   - å‡å°‘ chunk_size å‚æ•°
   - ä½¿ç”¨æ›´å°çš„æ¨¡åž‹

3. **è·¯å¾„é”™è¯¯**
   - ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
   - ä½¿ç”¨ç»å¯¹è·¯å¾„

4. **ç›¸ä¼¼åº¦è¿‡ä½Ž**
   - æ£€æŸ¥æ•°æ®è´¨é‡
   - è°ƒæ•´ min_similarity é˜ˆå€¼
   - å¢žåŠ æ–‡æœ¬åˆ†å—é‡å 

### æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨ GPUï¼šå®‰è£… `faiss-gpu` æ›¿ä»£ `faiss-cpu`
- æ‰¹é‡å¤„ç†ï¼šå¢žå¤§æ‰¹å¤„ç†å¤§å°
- ç´¢å¼•ä¼˜åŒ–ï¼šå¯¹å¤§æ•°æ®é›†ä½¿ç”¨ IVF ç´¢å¼•

## ä¾èµ–è¦æ±‚

è§ `requirements_embedding.txt`:
```
sentence-transformers>=2.2.0
faiss-cpu>=1.7.0
numpy>=1.21.0
torch>=1.9.0